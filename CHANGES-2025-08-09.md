

# BioMap Android Export + Storage Hardening (2025-08-09)

## Goals
- Re-enable native Android export to Documents with detailed progress and verification.
- Prevent storage quota errors when saving audio.
- Ensure truly fresh installs do not restore prior local data.
- Keep implementation within existing dependencies (no new packages).

## Changes

### Android native export restored and improved
- File: `src/utils/recordingExporter.js`
  - Fixed native detection to support Capacitor 5: now checks `isNative || isNativePlatform()`.
  - If no local blob is available but `recording.audioPath` exists, reads native file via Capacitor Filesystem and writes it to `Documents/BioMapp_Audio/`.
  - Keeps existing verification (`Filesystem.stat`) and logging (`biomap_export_log.txt`) with success/fail counts.

### Persist native audio path for future export
- File: `src/components/MapContainer.jsx`
  - When saving a recording, includes `audioPath` in metadata (if present) so exporter can use native files even when blobs aren’t stored.

### Avoid quota overflows on native
- File: `src/services/localStorageService.js`
  - On native platforms, `saveAudioBlob(...)` now skips writing blobs to localStorage to avoid quota errors.
  - Web behavior unchanged; large blobs are still capped by size guard.

### Clean installs don’t restore old data
- File: `android/app/src/main/AndroidManifest.xml`
  - Set `android:allowBackup="false"` to disable Android Auto Backup restoring WebView storage.
- File: `src/App.jsx`
  - Added one-time first-run cleanup for native: removes `manakai_audio_recordings`, `audio_*`, and `biomap_*` keys if not yet initialized.

### UX adjustments
- File: `src/components/SoundWalkAndroid.jsx`
  - Avoid duplicate/export-confusing alerts; native export shows a detailed results dialog, web fallback shows a generic download success message.

## Impact
- Android exports write to `Documents/BioMapp_Audio/` again with clear success/fail counts and logs.
- Recorder no longer triggers localStorage quota errors on native.
- Fresh installs won’t show restored, old recordings.

## Notes
- Existing recordings that have neither a blob nor a valid `audioPath` cannot be exported.
- Exporter still skips base64 conversion for blobs >10MB; native-path export is not limited by that check.

---

## Update: Revert to Blob/WebM-first Recording (later on 2025-08-09)

**NOTE: This approach was abandoned due to continued export issues**

## Final Update: Restored July JSZip-based Export (end of 2025-08-09)

### What changed
- File: `src/utils/recordingExporter.js`
  - **COMPLETELY RESTORED** the July working version that used JSZip to create downloadable ZIP files
  - **ENHANCED** with verbose progress tracking: shows processing status every 5 recordings
  - **ENHANCED** with detailed error handling and logging for each recording
  - **ENHANCED** with comprehensive result alerts showing success/fail counts, file sizes, and ZIP contents
  - Uses `localStorageService.getAudioBlobFlexible()` to get audio from localStorage or native files
  - Creates ZIP with `/audio/` folder containing individual files and `/metadata/` folder with JSON metadata
  - Includes `export_summary.json` and `export_log.txt` in the ZIP for full traceability
  - On Android: attempts to save ZIP to Downloads folder, falls back to browser download
  - Single ZIP download instead of multiple individual file writes

### Why this approach works
- **Simple and reliable**: No complex Capacitor Filesystem directory operations
- **Universal compatibility**: Works on web and mobile through WebView downloads  
- **No base64 conversion issues**: JSZip handles blob-to-zip conversion efficiently
- **Comprehensive logging**: Every step is logged and included in the ZIP
- **User-friendly**: Single download with organized folder structure
- **Proven**: This was the working version from July that users relied on

### Key differences from failed approaches
- **July (working)**: JSZip → single ZIP download → simple and reliable
- **Recent (broken)**: Individual file writes → complex filesystem operations → stack overflow errors
- **This restoration**: July approach + enhanced progress tracking and error handling

### Benefits
- ✅ No more "Maximum call stack size exceeded" errors
- ✅ Verbose progress tracking during export
- ✅ Detailed success/failure reporting  
- ✅ All files organized in a single ZIP
- ✅ Complete export logs included
- ✅ Works on both web and Android
- ✅ Saves to Android Downloads folder when possible

---

## Summary

This session successfully restored the reliable JSZip-based export functionality that was working in July, while preserving all the storage and playback fixes implemented earlier. The export now works as a single, comprehensive ZIP download with full logging and progress tracking - exactly what users need for a robust audio collection export experience.


